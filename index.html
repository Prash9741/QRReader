<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QR Scanner with Location</title>
  <style>
    :root {
      --bg: #0f1720;
      --card: #081024;
      --accent: #10b981;
      --muted: #9aa5b1;
      --white: #e6eef6;
    }

    * {
      box-sizing: border-box;
      font-family: Inter, system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color: var(--white);
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(180deg, #071227 0%, #051020 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 480px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.03), transparent);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(2, 6, 23, 0.6);
    }

    header {
      text-align: center;
      margin-bottom: 12px;
    }

    h1 {
      font-size: 18px;
      margin: 0 0 4px;
    }

    .video-wrap {
      position: relative;
      width: 100%;
      background: #010617;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 10px;
    }

    video {
      width: 100%;
      height: auto;
      background: #000;
      border-radius: 8px;
    }

    canvas#overlay {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 14px;
    }

    .box {
      background: var(--card);
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.03);
    }

    input,
    select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: none;
      margin-top: 5px;
      color: black;
    }

    button {
      background: var(--accent);
      border: none;
      color: #021;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
      text-align: center;
      transition: background 0.2s;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    pre {
      width: 100%;
      min-height: 120px;
      background: #021021;
      border: 1px solid rgba(255, 255, 255, 0.03);
      color: var(--white);
      padding: 8px;
      border-radius: 6px;
      resize: vertical;
      font-family: monospace;
      font-size: 13px;
    }

    .small {
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width:600px) {
      h1 {
        font-size: 16px;
      }

      pre {
        min-height: 100px;
      }
    }
  </style>
</head>

<body>

  <div class="app">
    <header>
      <h1>Mark Attendance</h1>
    </header>

    <div class="video-wrap">
      <video id="video" playsinline autoplay muted></video>
      <canvas id="overlay"></canvas>
    </div>
    <div id="formattedDate" style="margin-top:8px; font-size:16px; font-weight:700; text-align:center;">
    </div>

    <div class="controls">

      <!-- ðŸš€ NEW INPUT FIELDS -->
      <div class="box">

        <!-- Row fields -->
        <div style="display:flex; gap:10px; justify-content:space-between; align-items:center;">

          <div style="flex:1;">
            <label style="font-size:12px;">Roll</label>
            <input type="number" id="rollInput" min="2" max="99" value="5">
          </div>

          <div style="flex:1;">
            <label style="font-size:12px;">Date</label>
            <input type="date" id="dateInput" value="2025-11-13">
          </div>

          <div style="flex:1;">
            <label style="font-size:12px;">Course</label>
            <select id="courseInput">
              <option value="MCA">MCA</option>
              <option value="MBA">MBA</option>
              <option value="BCA">BCA</option>
              <option value="BTec">BTec</option>
            </select>
          </div>

        </div>

        <!-- Low visibility note -->
        <div style="margin-top:6px; font-size:11px; color:var(--muted); opacity:0.6; text-align:center;">
          Demo fields â€” will auto-fill for logged-in users
        </div>

      </div>



      <button id="mainBtn">Start Scan</button>

      <div class="box">
        <div class="small">Response:</div>
        <pre id="result">No response yet</pre>
      </div>
      <div class="small" id="status">Status: idle</div>
    </div>
  </div>

  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    function formatDate(inputDate) {
      const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

      const [year, month, day] = inputDate.split("-");
      return `${day}-${months[Number(month) - 1]}`;
    }

    const dateInput = document.getElementById("dateInput");
    const out = document.getElementById("formattedDate");

    // show formatted on load
    out.textContent = formatDate(dateInput.value);

    // show formatted on change
    dateInput.addEventListener("change", () => {
      out.textContent = formatDate(dateInput.value);
    });
  </script>

  <script>

    let student = {
      rollNo: null,
      date: null,
      course: null,
      section: 1,
      latitude: null,
      longitude: null,
    };

    class QRScanner {
      constructor(videoEl, overlayEl, buttonEl, resultEl, statusEl) {
        this.video = videoEl;
        this.overlay = overlayEl;
        this.button = buttonEl;
        this.resultEl = resultEl;
        this.statusEl = statusEl;

        this.canvas = document.createElement('canvas');
        this.ctx = this.canvas.getContext('2d');

        this.stream = null;
        this.scanning = false;
        this.scannedOnce = false;
        this.userLocation = null;

        this.init();
        this.attachEvents();
      }

      init() {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          this.statusEl.textContent = 'Status: camera API not supported';
          this.button.disabled = true;
        } else {
          this.statusEl.textContent = 'Status: ready';
        }
      }

      attachEvents() {
        this.button.addEventListener('click', async () => {
          if (this.button.textContent === 'Start Scan') {
            await this.requestLocationFirst();
          } else if (this.button.textContent === 'Stop Scan') {
            this.stopCamera();
          } else if (this.button.textContent === 'Scan Again') {
            this.scanning = true;
            this.scannedOnce = false;
            this.button.textContent = 'Stop Scan';
            this.statusEl.textContent = 'Status: scanning...';
            requestAnimationFrame(() => this.tick());
          }
        });
      }

      async requestLocationFirst() {
        this.statusEl.textContent = 'Status: requesting location...';
        this.button.textContent = 'Getting location...';
        this.button.disabled = true;

        try {
          const coords = await new Promise((resolve, reject) => {
            if (!navigator.geolocation) return reject(new Error('Geolocation not supported'));

            navigator.geolocation.getCurrentPosition(
              pos => resolve(pos.coords),
              err => reject(err),
              { enableHighAccuracy: true, timeout: 10000 }
            );
          });

          this.userLocation = coords;
          this.statusEl.textContent = 'Status: location acquired';
          this.button.textContent = 'Opening camera...';

          await this.openCamera();

        } catch (err) {
          console.warn('Location error:', err);
          this.statusEl.textContent = 'Status: location denied';
          this.button.textContent = 'Camera blocked (location required)';
          this.button.disabled = false;
          alert('Camera cannot be opened because location access is required.');
        }
      }

      async openCamera() {
        try {
          this.stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" }, audio: false
          });

          this.video.srcObject = this.stream;
          this.scanning = true;
          this.scannedOnce = false;
          this.button.textContent = 'Stop Scan';
          this.button.disabled = false;
          this.statusEl.textContent = 'Status: scanning...';

          requestAnimationFrame(() => this.tick());

        } catch (err) {
          console.error(err);
          this.statusEl.textContent = 'Status: camera access error';
          this.button.textContent = 'Start Scan';
        }
      }

      stopCamera() {
        if (this.stream) this.stream.getTracks().forEach(t => t.stop());
        this.scanning = false;
        this.button.textContent = 'Start Scan';
        this.statusEl.textContent = 'Status: stopped';
        this.overlay.getContext('2d').clearRect(0, 0, this.overlay.width, this.overlay.height);
      }

      resizeOverlay() {
        this.overlay.width = this.video.videoWidth;
        this.overlay.height = this.video.videoHeight;
      }

      processQRData(rawData) {
        let payload;
        try {
          payload = JSON.parse(rawData);
        } catch (err) {
          this.resultEl.textContent = "Invalid JSON:\n" + err;
          return;
        }

        // NEW: update student from input fields
        student.rollNo = Number(document.getElementById("rollInput").value);
        student.date = document.getElementById("dateInput").value;
        student.course = document.getElementById("courseInput").value;

        if (this.userLocation) {
          student.latitude = this.userLocation.latitude;
          student.longitude = this.userLocation.longitude;
        }
        const fixedUrl = `https://gulshan-deploy-348807148202.us-central1.run.app/Atten/MarkAttendance/${payload.code}`;
        this.sendPayload(fixedUrl, student);
      }

      sendPayload(url, student) {
        this.statusEl.textContent = "Status: sending POST...";

        fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(student),
        })
          .then(async (res) => {

            if (!res.ok) throw new Error(await res.text());

            const ct = res.headers.get("content-type") || "";
            const text = ct.includes("application/json")
              ? JSON.stringify(await res.json(), null, 2)
              : await res.text();

            this.resultEl.textContent = text;
            this.statusEl.textContent = "Status: Request Raised";

          })
          .catch((err) => {
            this.resultEl.textContent = "POST failed:\n" + err.message;
            this.statusEl.textContent = "Status: Request failed";
          });
      }

      tick() {
        if (!this.scanning) return;

        if (this.video.readyState === this.video.HAVE_ENOUGH_DATA) {
          this.resizeOverlay();
          this.canvas.width = this.video.videoWidth;
          this.canvas.height = this.video.videoHeight;

          this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
          const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);

          const code = jsQR(imageData.data, this.canvas.width, this.canvas.height, {
            inversionAttempts: "attemptBoth"
          });

          const octx = this.overlay.getContext('2d');
          octx.clearRect(0, 0, this.overlay.width, this.overlay.height);

          if (code && !this.scannedOnce) {

            octx.strokeStyle = "#10b981";
            octx.lineWidth = 4;

            const corners = code.location;
            octx.strokeRect(
              corners.topLeftCorner.x,
              corners.topLeftCorner.y,
              corners.topRightCorner.x - corners.topLeftCorner.x,
              corners.bottomLeftCorner.y - corners.topLeftCorner.y
            );

            this.scannedOnce = true;
            this.scanning = false;
            this.button.textContent = 'Scan Again';
            this.statusEl.textContent = 'Status: QR detected (paused)';

            this.processQRData(code.data);
            return;
          }
        }

        requestAnimationFrame(() => this.tick());
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      new QRScanner(
        document.getElementById('video'),
        document.getElementById('overlay'),
        document.getElementById('mainBtn'),
        document.getElementById('result'),
        document.getElementById('status')
      );
    });

  </script>

</body>


</html>
