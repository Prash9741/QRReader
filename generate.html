<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Time-Based QR Generator</title>
<style>
:root {
  --bg:#0f1720; --card:#081024; --accent:#10b981; --muted:#9aa5b1; --white:#e6eef6;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--white);}
body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071227 0%,#051020 100%);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:20px;}
.app{width:100%;max-width:480px;background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent);border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(2,6,23,0.6);}
h1{text-align:center;margin-top:0;font-size:20px;}
.qr-wrap{text-align:center;margin-top:20px;}
canvas{background:#fff;padding:8px;border-radius:8px;}
.code-display{font-size:22px;font-weight:700;text-align:center;margin-top:14px;color:var(--accent);letter-spacing:2px;}
.time-display{font-size:14px;text-align:center;margin-top:4px;color:var(--muted);}
.timer-bar{height:6px;background:rgba(255,255,255,0.1);border-radius:4px;margin-top:16px;overflow:hidden;}
.timer-fill{height:100%;width:0;background:var(--accent);}
</style>
</head>
<body>

<div class="app">
  <h1>Time-Based QR Generator</h1>
  <div class="qr-wrap" id="qrWrap"></div>
  <div class="code-display" id="codeDisplay">------</div>
  <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<script>
class QRGenerator {
  constructor(config) {
    this.postUrl = config.postUrl;
    this.baseJson = config.baseJson;
    this.secret = config.secret;
    this.windowSize = config.windowSize || 5;

    this.qrWrap = config.qrWrap;
    this.codeDisplay = config.codeDisplay;
    this.timerFill = config.timerFill;

    this.timerId = null;
  }

  async generateCode() {
    const nowUTC = Date.now(); // milliseconds UTC
    const utcSeconds = Math.floor(nowUTC / 1000);
    const window = Math.floor(utcSeconds / this.windowSize);
    // SHA-256 hash
    const data = new TextEncoder().encode(this.secret + window);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    const base36 = BigInt("0x" + hashHex).toString(36).toUpperCase();
    const code = base36.slice(0, 6);

    const humanTime = new Date(utcSeconds * 1000).toISOString();
    console.log("UTC Time:", humanTime, "Window:", window, "Code:", code);

    // Update display
    this.codeDisplay.textContent = code;
    this.baseJson.data.window=window;

    return code;
  }

  async generateQR() {
    const code = await this.generateCode();
    this.baseJson.data.code=code;
    const jsonData = JSON.stringify(this.baseJson);

    const qrData = `${this.postUrl}\n${jsonData}`;

    this.qrWrap.innerHTML = '';
    const canvas = document.createElement('canvas');
    this.qrWrap.appendChild(canvas);

    QRCode.toCanvas(canvas, qrData, { width: 260, margin: 1, color:{dark:"#000", light:"#fff"} });
    this.animateTimer(this.windowSize);
  }

  animateTimer(duration) {
    const start = Date.now();
    cancelAnimationFrame(this.timerId);

    const frame = () => {
      const elapsed = (Date.now() - start) / 1000;
      const progress = Math.min(elapsed / duration, 1);
      this.timerFill.style.width = (progress * 100) + "%";
      if(progress < 1){
        this.timerId = requestAnimationFrame(frame);
      } else {
        this.generateQR();
      }
    }

    this.timerFill.style.width = "0%";
    this.timerId = requestAnimationFrame(frame);
  }

  start() {
    this.generateQR();
  }
}

// Initialize
const qrApp = new QRGenerator({
  postUrl: "https://api.restful-api.dev/objects",
  baseJson: { name: "Prashant", data: {"window":"","code":""} },
  secret: "shared-secret-123",
  windowSize: 5,
  qrWrap: document.getElementById('qrWrap'),
  codeDisplay: document.getElementById('codeDisplay'),
  timerFill: document.getElementById('timerFill')
});

qrApp.start();
</script>
</body>
</html>
